{% extends "home.html" %}
{% block title %}
<title>Evaluation - Army ANT</title>
{% endblock %}

{% block content %}
<div class="columns">
  <div class="column col-12">
    <header>
      <h3>Evaluation</h3>
    </header>

    <form method="post" accept-charset="utf-8" enctype="multipart/form-data">
      <div class="columns">
        <div class="column">
          <div class="form-group">
            <label class="form-label" for="eval-format">Evaluator Format</label>
            <select class="form-select" id="eval-format" name="eval-format">
              <option value="inex">INEX</option>
              <option value="ll-api">Living Labs API</option>
            </select>
          </div>
        </div>

        <div class="column">
          <div class="form-group">
            <label class="form-label" for="engine">Search Engine</label>
            <select class="form-select" id="engine" name="engine">
              {% for app_engine in app.engines %}
              <option value="{{app_engine}}">{{ app.engines[app_engine].name }}</option>
              {% endfor %}
              <option value="__all__">All Engines</option>
            </select>
          </div>
        </div>
      </div>

      <div id="inex-block" class="columns dynamic-block">
        <div class="column">
          <div class="form-group">
            <label class="form-label" for="topics">Topics</label>
            <input class="form-input" type="file" id="topics" name="topics" value="">
          </div>
        </div>
        <div class="column">
          <div class="form-group">
            <label class="form-label" for="assessments">Assessments</label>
            <input class="form-input" type="file" id="assessments" name="assessments" value="">
          </div>
        </div>
      </div>

      <div id="ll-api-block" class="columns dynamic-block d-hide">
        <div class="column">
          <div class="form-group">
            <label class="form-label" for="base-url">Base URL</label>
            <input class="form-input" type="text" id="base-url" name="base-url" value="" placeholder="http://api.trec-open-search.org">
          </div>
        </div>
        <div class="column">
          <div class="form-group">
            <label class="form-label" for="api-key">API Key</label>
            <input class="form-input" type="text" id="api-key" name="api-key" value="" placeholder="2C2BB98ABEE4CD40-F0RDVC4KZ6SNFZGY">
          </div>
        </div>
        <div class="column">
          <div class="form-group">
            <label class="form-label" for="run-id">Run ID</label>
            <input class="form-input" type="text" id="run-id" name="run-id" value="" placeholder="retrieval_model-run_1">
          </div>
        </div>
      </div>

      <br>

      <div class="form-group">
        <button class="btn btn-primary" type="submit">Launch assessment</button>
        <button class="btn" type="reset">Clear form</button>
      </div>
    </form>
  </div>
</div>

<div class="divider"></div>

<div class="columns">
  <div class="column">
    <header>
      <h3>Tasks</h3>
    </header>

    {% if tasks|length > 0 %}
    
    <table class="table">
      <thead>
        <th>Queued</th>
        <th>Location</th>
        <th>Index</th>
        <th>Status</th>
        <th>Detail</th>
        <th>Manage</th>
      </thead>

      <tbody>
        {% for task in tasks %}

        {% set delete_url = app.router['evaluation_delete'].url_for().with_query(task_id=task._id) %}
        {% set reset_url = app.router['evaluation_reset'].url_for().with_query(task_id=task._id) %}
        
        {% if task.eval_format == 'll-api' %}
        {% set outcome_url = app.router['evaluation_results_ll_api'].url_for().with_query(task_id=task._id, fmt='html') %}
        {% endif %}

        <tr {% if task._id %} data-id="{{ task._id }}" data-delete-url="{{ delete_url }}" data-reset-url="{{ reset_url }}" {% endif %}
            {% if task.eval_format == 'll-api' %} data-outcome-url="{{ outcome_url }}" {% endif %}>
          <td>{{ task.time|timestamp_to_date }}</td>

          {% if task.eval_format == "inex" %}
          <td>{{ task.topics_filename}}; {{ task.assessments_filename }}</td>
          {% elif task.eval_format == "ll-api" %}
          <td>{{ task.base_url }}::{{ task.api_key }}::{{ task.run_id }}</td>
          {% endif %}

          <td>{{ task.index_location }} ({{ task.index_type }})</td>

          {% if task.status == 3 %}

          <td>
            <a href="{{ app.router['evaluation_results_archive'].url_for().with_query(task_id=task._id) }}">
              {{ task.status.name }} <i class="icon icon-download"></i>
            </a>
          </td>
          <td>
            <button class="inex-expand-btn btn btn-sm tooltip" data-tooltip="View computed evaluation metrics.">
              <i class="icon icon-plus"></i>
            </button>
          </td>

          {% elif task.status == 4 %}

          <td>{{ task.status.name }}</td>
          <td>
            <button class="ll-api-expand-btn btn btn-sm tooltip" data-tooltip="Request and view Living Labs API outcome.">
              <i class="icon icon-plus"></i>
            </button>
          </td>

          {% else %}

          <td>{{ task.status.name }}</td>
          <td>
            <button class="btn btn-sm disabled tooltip" data-tooltip="View evaluation results, when available.">
              <i class="icon icon-plus"></i>
            </button>
          </td>

          {% endif %}

          <td>
            <button class="task-delete-btn btn btn-sm tooltip" data-tooltip="Delete task and computed results.">
              <i class="icon icon-delete"></i>
            </button>
            <button
              class="task-reset-btn btn btn-sm tooltip"
              data-tooltip="Reset task to WAITING status.">
              <i class="icon icon-refresh"></i>
            </button>
          </td>
        </tr>

        {% if task.status == 3 %}
        <tr class="d-hide">
          <td colspan="5" class="text-center">
            <div class="wide-table">
              <table class="table table-two">
                <thead>
                  {% for metric in task.results %}
                  <th>{{ metric }}</th>
                  {% endfor %}
                </thead>
                <tbody>
                  <tr>
                    {% for metric in task.results %}
                    <td>{{ task.results[metric]|round(6) }}</td>
                    {% endfor %}
                  </tr>
                </tbody>
              </table>
            </div>
          </td>
        </tr>
        {% elif task.status == 4 and task.eval_format == 'll-api' %}
        <tr class="d-hide">
          <td colspan="5" class="text-center">
            <div class="ll-api-results">
              <i class="loading"></i>
              <div class="outcome"></div>
            </div>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>

    {% else %}

    <div class="empty">
      <div class="empty-icon">
        <i class="icon icon-2x icon-menu"></i>
      </div>
      <h4 class="empty-title">No evaluation tasks found</h4>
      <p class="empty-subtitle">Try to launch your own using the formulary above.</p>
    </div>

    {% endif %}
  </div>
</div>

<script type="text/javascript">
  (function() {
    $(document).on('click', '.task-reset-btn', function(e) {
      var taskID = $(this).parents('[data-id]').data('id');
      var $task = $('tr[data-id="' + taskID + '"]');
      var resetURL = $task.data('reset-url');

      if (confirm("Are you sure you want to reset this task?")) {
        $.ajax({
          url: resetURL,
          type: 'PUT',
          success: function(data, status, xhr) {
            $task.find('td:nth-child(4)').text("WAITING");
          },
          error: function(xhr, errorType, error) {
            var json = $.parseJSON(xhr.response);
            $('#error .message').text(json.error);
            $('#error').removeClass('d-hide');
          }
        });
      }
    });

    $(document).on('click', '.task-delete-btn', function(e) {
      var taskID = $(this).parents('[data-id]').data('id');
      var $task = $('tr[data-id="' + taskID + '"]');
      var deleteURL = $task.data('delete-url');

      if (confirm("Are you sure you want to delete this task?")) {
        $.ajax({
          url: deleteURL,
          type: 'DELETE',
          success: function(data, status, xhr) {
            $task.remove();
          },
          error: function(xhr, errorType, error) {
            var json = $.parseJSON(xhr.response);
            $('#error .message').text(json.error);
            $('#error').removeClass('d-hide');
          }
        });
      }
    });

    $(document).on('click', '.task-reset-btn', function(e) {
      console.log("reset");
    });

    $(document).on('click', '.inex-expand-btn', function(e) {
      var taskID = $(this).parents('[data-id]').data('id');
      var $detail = $('tr[data-id="' + taskID + '"]').next();

      if ($detail.hasClass('d-hide')) {
        $(this).find('i.icon').removeClass('icon-plus').addClass('icon-minus');
        $detail.removeClass('d-hide');
      } else {
        $(this).find('i.icon').removeClass('icon-minus').addClass('icon-plus');
        $detail.addClass('d-hide');
      }      
    });

    $(document).on('click', '.ll-api-expand-btn', function(e) {
      var taskID = $(this).parents('[data-id]').data('id');
      var $task = $('tr[data-id="' + taskID + '"]');
      var $detail = $task.next();
      var outcomeURL = $task.data('outcome-url');

      if ($detail.hasClass('d-hide')) {
        $(this).find('i.icon').removeClass('icon-plus').addClass('icon-minus');
        $detail.removeClass('d-hide');
        $.ajax({ url: outcomeURL }).done(function(html) {
          $detail.find('.loading').addClass('d-hide');
          $detail.find('.outcome').html(html);
        });
      } else {
        $(this).find('i.icon').removeClass('icon-minus').addClass('icon-plus');
        $detail.addClass('d-hide');
        $detail.find('.loading').removeClass('d-hide');
        $detail.find('.outcome').html('');
      }      
    });

    $(document).on('change', '#eval-format', function(e) {
      var evalFormat = $(this).val();
      $('.dynamic-block').addClass('d-hide');
      $('#' + evalFormat + '-block').removeClass('d-hide');
    });
  })();
</script>

{% if error %}
<script type="text/javascript">
  (function() {
    $('#error .message').text('{{ error }}');
    $('#error').removeClass('d-hide');
  })();
</script>
{% endif %}

{% endblock %}
