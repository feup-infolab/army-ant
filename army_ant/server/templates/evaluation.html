{% extends "home.html" %}
{% block title %}Evaluation{% endblock %}

{% block content %}

<h3>Evaluation</h3>

{% include 'evaluation/form.html' %}

<div class="divider spaced"></div>

<div class="columns">
  <div class="column">
    <h3>Tasks</h3>
  </div>
  <div class="column text-right">
    <div class="btn-group">
      <button class="btn generate-btn tooltip" data-tooltip="Generate CSV/LaTeX with all results.">
        Download <i class="icon icon-download"></i>
      </button>
      <button class="btn expand-all-btn tooltip" data-tooltip="Expand all assessment results.">
        Expand All <i class="icon icon-plus"></i>
      </button>
      <button class="btn collapse-all-btn tooltip" data-tooltip="Collapse all assessment results.">
        Collapse All <i class="icon icon-minus"></i>
      </button>
    </div>
  </div>
</div>

{% include 'evaluation/download.html' %}

{% if tasks|length > 0 %}

{% include 'evaluation/tasks.html' %}

{% else %}

<div class="empty">
  <div class="empty-icon">
    <i class="icon icon-2x icon-menu"></i>
  </div>
  <h4 class="empty-title">No evaluation tasks found</h4>
  <p class="empty-subtitle">Try to launch your own using the formulary above.</p>
</div>

{% endif %}

<script type="text/javascript">
  (function() {
    function isInteger(n) {
      return !isNaN(parseInt(n)) && isFinite(n);
    }

    function addDecimalPlaces(n) {
      var value = +$('#decimals-input').val();
      var nextValue = value;

      if (!isInteger(value)) {
        nextValue = 4;
      } else {
        nextValue += n;
        if (nextValue < 1) {
          nextValue = 1;
        } else if (nextValue > 10) {
          nextValue = 10;
        }
      }
      $('#decimals-input').val(nextValue);
    }

    var incTimeoutID = 0;
    var incIntervalID = 0;
    $(document).on('mousedown mouseup', '#decimals-inc', function(e) {
      clearTimeout(incTimeoutID);
      if (e.type == 'mousedown') {
        addDecimalPlaces(1);
        incTimeoutID = setTimeout(function() {
          incIntervalID = setInterval(function() { addDecimalPlaces(1); }, 50);
        }, 500);
      } else {
        clearTimeout(incIntervalID);
      }
    });

    var decTimeoutID = 0;
    var decIntervalID = 0;
    $(document).on('mousedown mouseup', '#decimals-dec', function(e) {
      clearTimeout(decTimeoutID);
      if (e.type == 'mousedown') {
        addDecimalPlaces(-1);
        decTimeoutID = setTimeout(function() {
          decIntervalID = setInterval(function() { addDecimalPlaces(-1); }, 50);
        }, 500);
      } else {
        clearTimeout(decIntervalID);
      }
    });

    function downloadSummary($modal, format) {
      var headers = [];
      if ($modal.find('#index-runid-checkbox').prop('checked')) {
        headers.push($modal.find('#index-runid-checkbox').val());
      }
      if ($modal.find('#index-type-checkbox').prop('checked')) {
        headers.push($modal.find('#index-type-checkbox').val());
      }
      if ($modal.find('#index-location-checkbox').prop('checked')) {
        headers.push($modal.find('#index-location-checkbox').val());
      }
      headers = headers.join(',');
  
      var metrics = $modal.find('.metrics input[type="checkbox"]:checked')
        .map(function(index, item) { return $(item).val(); })
        .toArray().join(',');

      var decimals = $modal.find('#decimals-input').val();
      if (!format) format = $modal.find('input[name="format"]:checked').val();
      
      var downloadURL = $modal.data('download-url');

      var params = [];
      if (headers) params.push('headers=' + headers);
      if (metrics) params.push('metrics=' + metrics);
      if (decimals) params.push('decimals=' + decimals);
      if (format) params.push('fmt=' + format);
      if (params.length > 0) {
        downloadURL += '?' + params.join('&');
      }

      if (format == 'html') {
        $('#html-preview').append($('<i>').addClass('loading'));
        $.get(downloadURL, function(html) {
          $('#html-preview').html(html);
        });
      } else {
        window.location = downloadURL;
      }
    }

    $(document).on('click', '#download-btn', function(e) {
      var $modal = $(this).parents('.modal.generate');
      $('#html-preview').empty();
      downloadSummary($modal);
    });

    $(document).on('click', '#preview-btn', function(e) {
      var $modal = $(this).parents('.modal.generate');
      downloadSummary($modal, 'html');
    });
 
    $(document).on('change', '.toggle-metric-checkbox', function(e) {
      console.log($('.toggle-metric-checkbox:checked').length);
      if ($('.toggle-metric-checkbox:checked').length == 0) {
        $('.toggle-all-metrics-checkbox').prop('checked', true);
      }
    });

    $(document).on('change', '.toggle-all-metrics-checkbox', function(e) {
      if ($(this).prop('checked')) {
        $(this).parents('.modal')
          .find('.metrics input[type="checkbox"]')
          .prop('checked', true);
      } else {
        $(this).parents('.modal')
          .find('.metrics input[type="checkbox"]').prop('checked', false);
      }
    });

    $(document).on('click', '.select-classic-metrics-btn', function(e) {
      var metrics = ['MAP', 'P@10', 'NDCG@10'];

      $(this).parents('.modal')
        .find('.metrics input[type="checkbox"]')
        .prop('checked', false);

      for (var i=0; i < metrics.length; i++) {
        $(this).parents('.modal')
          .find('.metrics input[type="checkbox"][value="' + metrics[i] + '"]')
          .prop('checked', true);
      }
    });

    $(document).on('click', '.expand-all-btn', function(e) {
      $('.eval').forEach(function(task) {
        expandDetails($(task));
      });
    });

    $(document).on('click', '.collapse-all-btn', function(e) {
      $('.eval').forEach(function(task) {
        collapseDetails($(task));
      });
    });

    $(document).on('click', '.generate-btn', function(e) {
      var $modal = $('.modal.generate');
      $modal.addClass('active');
    });

    $(document).on('click', '.close-modal-btn', function(e) {
      var $modal = $(this).parents('.modal');
      $('#html-preview').empty();
      $modal.removeClass('active');
    });

    $(document).on('click', '.task-rename-btn', function(e) {
      e.preventDefault();

      var $task = $(this).parents('[data-id]');
      var $runID = $task.find('.run-id-rename-input');

      $runID
        .css('flex', 'none')
        .css('min-width', '15ex')
        .css('max-width', '80ex')
        .css('width', $task.find('.title').width() + 'px');
      $task.find('.title-display').addClass('d-hide');
      $task.find('.title-edit').removeClass('d-hide');
      $runID.focus();
    });

    function confirmRename($task) {
      var runID = $task.find('.run-id-rename-input').val();
      if (runID === undefined || runID === null || runID === "") return;
      var renameURL = $task.data('rename-url') + '&run_id=' + runID;

      $.ajax({
        url: renameURL,
        type: 'PUT',
        success: function(data, status, xhr) {
          $task.find('.title').text(runID);
          $task.find('.title-display').removeClass('d-hide');
          $task.find('.title-edit').addClass('d-hide');
        },
        error: function(xhr, errorType, error) {
          var json = $.parseJSON(xhr.response);
          $('#error .message').text(json.error);
          $('#error').removeClass('d-hide');
        }
      });
    }

    function cancelRename($task) {
      $task.find('.run-id-rename-input').val($task.find('.title').text());
      $task.find('.title-display').removeClass('d-hide');
      $task.find('.title-edit').addClass('d-hide');
    }

    $(document).on('keydown', '.run-id-rename-input', function(e) {
      var $task = $(this).parents('[data-id]');
      if (e.keyCode == 13) confirmRename($task);
      if (e.keyCode == 27) cancelRename($task);
    });

    $(document).on('click', '.task-rename-confirm-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      confirmRename($task);
    });

    $(document).on('click', '.task-rename-cancel-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      cancelRename($task);
    });

    $(document).on('click', '.task-reset-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      var resetURL = $task.data('reset-url');

      if (confirm("Are you sure you want to reset this task?")) {
        $.ajax({
          url: resetURL,
          type: 'PUT',
          success: function(data, status, xhr) {
            $task.find('.status').text("WAITING");
          },
          error: function(xhr, errorType, error) {
            var json = $.parseJSON(xhr.response);
            $('#error .message').text(json.error);
            $('#error').removeClass('d-hide');
          }
        });
      }
    });

    $(document).on('click', '.task-delete-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      var deleteURL = $task.data('delete-url');

      if (confirm("Are you sure you want to delete this task?")) {
        $.ajax({
          url: deleteURL,
          type: 'DELETE',
          success: function(data, status, xhr) {
            $task.remove();
          },
          error: function(xhr, errorType, error) {
            var json = $.parseJSON(xhr.response);
            $('#error .message').text(json.error);
            $('#error').removeClass('d-hide');
          }
        });
      }
    });

    $(document).on('click', '.expand-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      toggleDetails($task);
    });

    function toggleDetails($task) {
      var taskFormat = $task.data('format');
      var $detail = $task.find('.detail');

      if ($detail.hasClass('d-hide')) {
        if (taskFormat == 'inex') {
          expandDetailsINEX($task, $detail);
        } else if (taskFormat == 'll-api') {
          expandDetailsLLAPI($task, $detail);
        }
      } else {
        if (taskFormat == 'inex') {
          collapseDetailsINEX($task, $detail);
        } else if (taskFormat == 'll-api') {
          collapseDetailsLLAPI($task, $detail);
        }
      }
    }

    function expandDetails($task) {
      var taskFormat = $task.data('format');
      var $detail = $task.find('.detail');

      if (taskFormat == 'inex') {
        expandDetailsINEX($task, $detail);
      } else if (taskFormat == 'll-api') {
        expandDetailsLLAPI($task, $detail);
      }
    }

    function collapseDetails($task) {
      var taskFormat = $task.data('format');
      var $detail = $task.find('.detail');

      if (taskFormat == 'inex') {
        collapseDetailsINEX($task, $detail);
      } else if (taskFormat == 'll-api') {
        collapseDetailsLLAPI($task, $detail);
      }
    }

    function expandDetailsINEX($task, $detail) {
      $task.find('.expand-btn i.icon').removeClass('icon-plus').addClass('icon-minus');
      $detail.removeClass('d-hide');
    }

    function collapseDetailsINEX($task, $detail) {
      $task.find('.expand-btn i.icon').removeClass('icon-minus').addClass('icon-plus');
      $detail.addClass('d-hide');
    }

    function expandDetailsLLAPI($task, $detail) {
      var outcomeURL = $task.data('outcome-url');
      $task.find('.expand-btn i.icon').removeClass('icon-plus').addClass('icon-minus');
      $detail.removeClass('d-hide');
      $.ajax({ url: outcomeURL }).done(function(html) {
        $detail.find('.loading').addClass('d-hide');
        $detail.find('.outcome').html(html);
      });
    }

    function collapseDetailsLLAPI($task, $detail) {
      $task.find('.expand-btn i.icon').removeClass('icon-minus').addClass('icon-plus');
      $detail.addClass('d-hide');
      $detail.find('.loading').removeClass('d-hide');
      $detail.find('.outcome').html('');
    }
  })();
</script>

{% if error %}
<script type="text/javascript">
  (function() {
    $('#error .message').text('{{ error }}');
    $('#error').removeClass('d-hide');
  })();
</script>
{% endif %}

{% endblock %}
