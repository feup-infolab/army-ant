{% extends "home.html" %}
{% block title %}
<title>Evaluation - Army ANT</title>
{% endblock %}

{% block content %}

<h3>Evaluation</h3>

<form method="post" accept-charset="utf-8" enctype="multipart/form-data">
  <div class="columns">
    <div class="column">
      <div class="form-group">
        <label class="form-label" for="eval-format">Evaluator Format</label>
        <select class="form-select" id="eval-format" name="eval-format">
          <option value="inex">INEX</option>
          <option value="ll-api">Living Labs API</option>
        </select>
      </div>
    </div>

    <div class="column">
      <div class="form-group">
        <label class="form-label" for="engine">Search Engine</label>
        <select class="form-select" id="engine" name="engine">
          {% for app_engine in app.engines %}
          <option value="{{app_engine}}">{{ app.engines[app_engine].name }}</option>
          {% endfor %}
          <option value="__all__">All Engines</option>
        </select>
      </div>
    </div>
  </div>

  <div id="inex-block" class="columns dynamic-block">
    <div class="column col-6">
      <div class="form-group">
        <label class="form-label" for="topics">Topics</label>
        <input class="form-input" type="file" id="topics" name="topics" value="">
      </div>
    </div>
    <div class="column col-6">
      <div class="form-group">
        <label class="form-label" for="assessments">Assessments</label>
        <input class="form-input" type="file" id="assessments" name="assessments" value="">
      </div>
    </div>
    <div class="column col-12">
      <div class="form-group">
        <label class="form-label" for="run-id">Run ID</label>
        <input class="form-input input-tall" type="text" id="run-id" name="run-id" value="" placeholder="Dataset - retrieval model">
      </div>
    </div>
  </div>

  <div id="ll-api-block" class="columns dynamic-block d-hide">
    <div class="column col-6">
      <div class="form-group">
        <label class="form-label" for="base-url">Base URL</label>
        <input class="form-input input-tall" type="text" id="base-url" name="base-url" value="" placeholder="http://api.trec-open-search.org">
      </div>
    </div>
    <div class="column col-6">
      <div class="form-group">
        <label class="form-label" for="api-key">API Key</label>
        <input class="form-input input-tall" type="text" id="api-key" name="api-key" value="" placeholder="2C2BB98ABEE4CD40-F0RDVC4KZ6SNFZGY">
      </div>
    </div>
    <div class="column col-12">
      <div class="form-group">
        <label class="form-label" for="run-id">Run ID</label>
        <input class="form-input input-tall" type="text" id="run-id" name="run-id" value="" placeholder="Dataset - retrieval model - run">
      </div>
    </div>
  </div>

  <br>

  <div class="form-group">
    <button class="btn btn-primary" type="submit">Launch assessment</button>
    <button class="btn" type="reset">Clear form</button>
  </div>
</form>

<div class="divider spaced"></div>

<div class="columns">
  <div class="column">
    <h3>Tasks</h3>
  </div>
  <div class="column text-right">
    <div class="btn-group">
      <button class="btn generate-btn tooltip" data-tooltip="Generate CSV/LaTeX with all results.">
        Download <i class="icon icon-download"></i>
      </button>
      <button class="btn expand-all-btn tooltip" data-tooltip="Expand all assessment results.">
        Expand All <i class="icon icon-plus"></i>
      </button>
      <button class="btn collapse-all-btn tooltip" data-tooltip="Collapse all assessment results.">
        Collapse All <i class="icon icon-minus"></i>
      </button>
    </div>
  </div>
</div>

<div class="modal generate" data-download-url="{{ app.router['evaluation_download'].url_for() }}">
  <div class="modal-overlay"></div>
  <div class="modal-container">
    <div class="modal-header">
      <div class="columns">
        <div class="column">
          <div class="modal-title h5">Configure output</div>
        </div>

        <div class="column text-right">
          <div class="form-group">
            <label class="form-radio">
              <input type="radio" name="format" value="csv" checked="checked">
              <i class="form-icon"></i> CSV
            </label>
            <label class="form-radio">
              <input type="radio" name="format" value="tex">
              <i class="form-icon"></i> LaTeX
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-body">
      <div class="content">
        <div class="container">
          <div class="columns">
            <div class="form-group">
              <label class="form-switch">
                <input class="toggle-all-metrics-checkbox" type="checkbox" checked="checked">
                <i class="form-icon"></i> Toggle all
              </label>
            </div>
            <button class="btn btn-sm select-classic-metrics-btn">Select Classic</button>
          </div>

          <br>

          {% set metrics_length = metrics|length %}
          <div class="columns metrics">
            <div class="column">
              {% for metric in metrics[0:(metrics_length//2)] %}
              <div class="form-group">
                <label class="form-checkbox">
                  <input class="toggle-metric-checkbox" type="checkbox" checked="checked" value="{{ metric }}">
                  <i class="form-icon"></i> {{ metric }}
                </label>
              </div>
              {% endfor %}
            </div>

            <div class="column">
              {% for metric in metrics[(metrics_length//2+1):metrics_length] %}
              <div class="form-group">
                <label class="form-checkbox">
                  <input type="checkbox" checked="checked" value="{{ metric }}">
                  <i class="form-icon"></i> {{ metric }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <br>

          <div class="columns">
            <div class="column col-5">
              <div class="form-group">
                <label class="form-label" for="decimals-input">Decimals</label>
                <div class="input-group">
                  <input id="decimals-input" class="form-input input-sm" type="text" placeholder="Number of decimal places" value="4"
                    style="max-width: 70%;">
                  <button id="decimals-inc" class="btn btn-sm input-group-btn"><i class="icon icon-arrow-up"></i></button>
                  <button id="decimals-dec" class="btn btn-sm input-group-btn"><i class="icon icon-arrow-down"></i></button>
                </div>
              </div>
            </div>

            <div class="column col-7">
              <div class="form-group">
                <label class="form-label">Columns</label>
                <label class="form-checkbox">
                  <input id="index-runid-checkbox" type="checkbox" checked="checked" value="Run ID">
                  <i class="form-icon"></i> Run ID
                </label>
                <label class="form-checkbox">
                  <input id="index-type-checkbox" type="checkbox" value="Type">
                  <i class="form-icon"></i> Type
                </label>
                <label class="form-checkbox">
                  <input id="index-location-checkbox" type="checkbox" value="Location">
                  <i class="form-icon"></i> Location
                </label>
              </div>
            </div>
          </div>

          <div id="html-preview"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn close-modal-btn">Cancel</button>
      <button id="preview-btn" class="btn tooltip" data-tooltip="Preview"><i class="icon icon-search"></i></button>
      <button id="download-btn" class="btn btn-primary">Download</button>
    </div>
  </div>
</div>

{% if tasks|length > 0 %}

{% for task in tasks|sort(attribute='time', reverse=True) %}

{% set delete_url = app.router['evaluation_delete'].url_for().with_query(task_id=task._id) %}
{% set reset_url = app.router['evaluation_reset'].url_for().with_query(task_id=task._id) %}
{% set rename_url = app.router['evaluation_rename'].url_for().with_query(task_id=task._id) %}

{% if task.eval_format == 'll-api' %}
{% set outcome_url = app.router['evaluation_results_ll_api'].url_for().with_query(task_id=task._id, fmt='html') %}
{% endif %}

<div class="card eval"
  {% if task._id %} data-id="{{ task._id }}" data-format="{{ task.eval_format }}" data-delete-url="{{ delete_url }}"
    data-reset-url="{{ reset_url }}" data-rename-url="{{ rename_url }}" {% endif %}
  {% if task.eval_format == 'll-api' %} data-outcome-url="{{ outcome_url }}" {% endif %}>

  <div class="card-header">
    <div class="columns">
      <div class="column col-10">
        <div class="card-title h6">
          <div class="title-display">
            <span class="title">{{ task.run_id }}</span>
            <a class="task-rename-btn" href="#"><small><i class="icon icon-edit"></i></small></a>
          </div>
          <div class="input-group title-edit d-hide">
            <input class="form-input input-sm run-id-rename-input" type="text" value="{{ task.run_id}}"
              placeholder="Rename task run ID">
            <button class="btn btn-sm input-group-btn task-rename-confirm-btn">OK</button>
            <button class="btn btn-sm input-group-btn task-rename-cancel-btn">Cancel</button>
          </div>
        </div>
        <div class="card-subtitle text-gray">Queued: {{ task.time|timestamp_to_date }}</div>
      </div>

      <!-- START DETAIL BUTTONS -->
      <div class="column col-2 text-right">
        <div class="btn-group">
          {% if task.status == 3 %}

          <a class="btn btn-sm tooltip" data-tooltip="Download ZIP file with evaluation details."
            href="{{ app.router['evaluation_results_archive'].url_for().with_query(task_id=task._id) }}">
            <i class="icon icon-download"></i>
          </a>
          <button class="expand-btn btn btn-sm tooltip" data-tooltip="View computed evaluation metrics.">
            <i class="icon icon-plus"></i>
          </button>

          {% elif task.status == 4 %}

          <button class="expand-btn btn btn-sm tooltip" data-tooltip="Request and view Living Labs API outcome.">
            <i class="icon icon-plus"></i>
          </button>

          {% else %}

          <button class="btn btn-sm disabled tooltip" data-tooltip="View evaluation results, when available.">
            <i class="icon icon-plus"></i>
          </button>

          {% endif %}
        </div>
      </div>
      <!-- END DETAIL BUTTONS -->
    </div>
  </div>

  <div class="card-body">
    <table class="table table-striped table-sm metadata">
      <tr>
        <th>Index Location</th>
        <td>{{ task.index_location }}</td>
      </tr>
      <tr>
        <th>Index Type</th>
        <td>{{ task.index_type }}</td>
      </tr>

      {% if task.eval_format == "inex" %}

      <!-- START INEX METADATA -->
      <tr>
        <th>Topics Filename</th>
        <td>{{ task.topics_filename}}</td>
      </tr>
      <tr>
        <th>Assessments Filename</th>
        <td>{{ task.assessments_filename }}</td>
      </tr>
      <!-- END INEX METADATA -->

      {% elif task.eval_format == "ll-api" %}

      <!-- START LL-API METADATA -->
      <tr>
        <th>Base URL</th>
        <td>{{ task.base_url }}</td>
      </tr>
      <tr>
        <th>API Key</th>
        <td>{{ task.api_key }}</td>
      </tr>
      <!-- END LL-API METADATA -->

      {% endif %}
    </table>

    <!-- START DETAIL -->
    {% if task.status == 3 %}
    <div class="d-hide detail">
      <table class="table table-scroll table-sm">
        <thead>
          {% for metric in task.results %}
          <th>{{ metric }}</th>
          {% endfor %}
        </thead>
        <tbody>
          <tr>
            {% for metric in task.results %}
            <td>{{ task.results[metric]|round(6) }}</td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>
    {% elif task.status == 4 and task.eval_format == 'll-api' %}
    <div class="d-hide detail ll-api-results">
      <i class="loading"></i>
      <div class="outcome"></div>
    </div>
    {% endif %}
    <!-- END DETAIL -->
  </div>

  <div class="card-footer">
    <div class="columns">
      <!-- START STATUS -->
      <div class="column">
        <span class="label label-rounded label-primary status">
          {{ task.status.name }} 
        </span>
      </div>
      <!-- END STATUS -->

      <!-- START TASK BUTTONS -->
      <div class="column text-right">
        <div class="btn-group">
          <button class="task-delete-btn btn btn-primary btn-sm tooltip" data-tooltip="Delete task and computed results.">
            <i class="icon icon-delete"></i>
          </button>
          <button
            class="task-reset-btn btn btn-primary btn-sm tooltip"
            data-tooltip="Reset task to WAITING status.">
            <i class="icon icon-refresh"></i>
          </button>
        </div>
      </div>
      <!-- END TASK BUTTONS -->
    </div>
  </div>
</div>
{% endfor %}

{% else %}

<div class="empty">
  <div class="empty-icon">
    <i class="icon icon-2x icon-menu"></i>
  </div>
  <h4 class="empty-title">No evaluation tasks found</h4>
  <p class="empty-subtitle">Try to launch your own using the formulary above.</p>
</div>

{% endif %}

<script type="text/javascript">
  (function() {
    function isInteger(n) {
      return !isNaN(parseInt(n)) && isFinite(n);
    }

    function addDecimalPlaces(n) {
      var value = +$('#decimals-input').val();
      var nextValue = value;

      if (!isInteger(value)) {
        nextValue = 4;
      } else {
        nextValue += n;
        if (nextValue < 1) {
          nextValue = 1;
        } else if (nextValue > 10) {
          nextValue = 10;
        }
      }
      $('#decimals-input').val(nextValue);
    }

    var incTimeoutID = 0;
    var incIntervalID = 0;
    $(document).on('mousedown mouseup', '#decimals-inc', function(e) {
      clearTimeout(incTimeoutID);
      if (e.type == 'mousedown') {
        addDecimalPlaces(1);
        incTimeoutID = setTimeout(function() {
          incIntervalID = setInterval(function() { addDecimalPlaces(1); }, 50);
        }, 500);
      } else {
        clearTimeout(incIntervalID);
      }
    });

    var decTimeoutID = 0;
    var decIntervalID = 0;
    $(document).on('mousedown mouseup', '#decimals-dec', function(e) {
      clearTimeout(decTimeoutID);
      if (e.type == 'mousedown') {
        addDecimalPlaces(-1);
        decTimeoutID = setTimeout(function() {
          decIntervalID = setInterval(function() { addDecimalPlaces(-1); }, 50);
        }, 500);
      } else {
        clearTimeout(decIntervalID);
      }
    });

    function downloadSummary($modal, format) {
      var headers = [];
      if ($modal.find('#index-runid-checkbox').prop('checked')) {
        headers.push($modal.find('#index-runid-checkbox').val());
      }
      if ($modal.find('#index-type-checkbox').prop('checked')) {
        headers.push($modal.find('#index-type-checkbox').val());
      }
      if ($modal.find('#index-location-checkbox').prop('checked')) {
        headers.push($modal.find('#index-location-checkbox').val());
      }
      headers = headers.join(',');
  
      var metrics = $modal.find('.metrics input[type="checkbox"]:checked')
        .map(function(index, item) { return $(item).val(); })
        .toArray().join(',');

      var decimals = $modal.find('#decimals-input').val();
      if (!format) format = $modal.find('input[name="format"]:checked').val();
      
      var downloadURL = $modal.data('download-url');

      var params = [];
      if (headers) params.push('headers=' + headers);
      if (metrics) params.push('metrics=' + metrics);
      if (decimals) params.push('decimals=' + decimals);
      if (format) params.push('fmt=' + format);
      if (params.length > 0) {
        downloadURL += '?' + params.join('&');
      }

      if (format == 'html') {
        $('#html-preview').append($('<i>').addClass('loading'));
        $.get(downloadURL, function(html) {
          $('#html-preview').html(html);
        });
      } else {
        window.location = downloadURL;
      }
    }

    $(document).on('click', '#download-btn', function(e) {
      var $modal = $(this).parents('.modal.generate');
      $('#html-preview').empty();
      downloadSummary($modal);
    });

    $(document).on('click', '#preview-btn', function(e) {
      var $modal = $(this).parents('.modal.generate');
      downloadSummary($modal, 'html');
    });
 
    $(document).on('change', '.toggle-metric-checkbox', function(e) {
      console.log($('.toggle-metric-checkbox:checked').length);
      if ($('.toggle-metric-checkbox:checked').length == 0) {
        $('.toggle-all-metrics-checkbox').prop('checked', true);
      }
    });

    $(document).on('change', '.toggle-all-metrics-checkbox', function(e) {
      if ($(this).prop('checked')) {
        $(this).parents('.modal')
          .find('.metrics input[type="checkbox"]')
          .prop('checked', true);
      } else {
        $(this).parents('.modal')
          .find('.metrics input[type="checkbox"]').prop('checked', false);
      }
    });

    $(document).on('click', '.select-classic-metrics-btn', function(e) {
      var metrics = ['MAP', 'P@10', 'NDCG@10'];

      $(this).parents('.modal')
        .find('.metrics input[type="checkbox"]')
        .prop('checked', false);

      for (var i=0; i < metrics.length; i++) {
        $(this).parents('.modal')
          .find('.metrics input[type="checkbox"][value="' + metrics[i] + '"]')
          .prop('checked', true);
      }
    });

    $(document).on('click', '.expand-all-btn', function(e) {
      $('.eval').forEach(function(task) {
        expandDetails($(task));
      });
    });

    $(document).on('click', '.collapse-all-btn', function(e) {
      $('.eval').forEach(function(task) {
        collapseDetails($(task));
      });
    });

    $(document).on('click', '.generate-btn', function(e) {
      var $modal = $('.modal.generate');
      $modal.addClass('active');
    });

    $(document).on('click', '.close-modal-btn', function(e) {
      var $modal = $(this).parents('.modal');
      $('#html-preview').empty();
      $modal.removeClass('active');
    });

    $(document).on('click', '.task-rename-btn', function(e) {
      e.preventDefault();

      var $task = $(this).parents('[data-id]');
      var $runID = $task.find('.run-id-rename-input');

      $runID
        .css('flex', 'none')
        .css('min-width', '15ex')
        .css('max-width', '80ex')
        .css('width', $task.find('.title').width() + 'px');
      $task.find('.title-display').addClass('d-hide');
      $task.find('.title-edit').removeClass('d-hide');
      $runID.focus();
    });

    function confirmRename($task) {
      var runID = $task.find('.run-id-rename-input').val();
      if (runID === undefined || runID === null || runID === "") return;
      var renameURL = $task.data('rename-url') + '&run_id=' + runID;

      $.ajax({
        url: renameURL,
        type: 'PUT',
        success: function(data, status, xhr) {
          $task.find('.title').text(runID);
          $task.find('.title-display').removeClass('d-hide');
          $task.find('.title-edit').addClass('d-hide');
        },
        error: function(xhr, errorType, error) {
          var json = $.parseJSON(xhr.response);
          $('#error .message').text(json.error);
          $('#error').removeClass('d-hide');
        }
      });
    }

    function cancelRename($task) {
      $task.find('.run-id-rename-input').val($task.find('.title').text());
      $task.find('.title-display').removeClass('d-hide');
      $task.find('.title-edit').addClass('d-hide');
    }

    $(document).on('keydown', '.run-id-rename-input', function(e) {
      var $task = $(this).parents('[data-id]');
      if (e.keyCode == 13) confirmRename($task);
      if (e.keyCode == 27) cancelRename($task);
    });

    $(document).on('click', '.task-rename-confirm-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      confirmRename($task);
    });

    $(document).on('click', '.task-rename-cancel-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      cancelRename($task);
    });

    $(document).on('click', '.task-reset-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      var resetURL = $task.data('reset-url');

      if (confirm("Are you sure you want to reset this task?")) {
        $.ajax({
          url: resetURL,
          type: 'PUT',
          success: function(data, status, xhr) {
            $task.find('.status').text("WAITING");
          },
          error: function(xhr, errorType, error) {
            var json = $.parseJSON(xhr.response);
            $('#error .message').text(json.error);
            $('#error').removeClass('d-hide');
          }
        });
      }
    });

    $(document).on('click', '.task-delete-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      var deleteURL = $task.data('delete-url');

      if (confirm("Are you sure you want to delete this task?")) {
        $.ajax({
          url: deleteURL,
          type: 'DELETE',
          success: function(data, status, xhr) {
            $task.remove();
          },
          error: function(xhr, errorType, error) {
            var json = $.parseJSON(xhr.response);
            $('#error .message').text(json.error);
            $('#error').removeClass('d-hide');
          }
        });
      }
    });

    $(document).on('click', '.expand-btn', function(e) {
      var $task = $(this).parents('[data-id]');
      toggleDetails($task);
    });

    $(document).on('change', '#eval-format', function(e) {
      var evalFormat = $(this).val();
      $('.dynamic-block').addClass('d-hide');
      $('#' + evalFormat + '-block').removeClass('d-hide');
    });

    function toggleDetails($task) {
      var taskFormat = $task.data('format');
      var $detail = $task.find('.detail');

      if ($detail.hasClass('d-hide')) {
        if (taskFormat == 'inex') {
          expandDetailsINEX($task, $detail);
        } else if (taskFormat == 'll-api') {
          expandDetailsLLAPI($task, $detail);
        }
      } else {
        if (taskFormat == 'inex') {
          collapseDetailsINEX($task, $detail);
        } else if (taskFormat == 'll-api') {
          collapseDetailsLLAPI($task, $detail);
        }
      }
    }

    function expandDetails($task) {
      var taskFormat = $task.data('format');
      var $detail = $task.find('.detail');

      if (taskFormat == 'inex') {
        expandDetailsINEX($task, $detail);
      } else if (taskFormat == 'll-api') {
        expandDetailsLLAPI($task, $detail);
      }
    }

    function collapseDetails($task) {
      var taskFormat = $task.data('format');
      var $detail = $task.find('.detail');

      if (taskFormat == 'inex') {
        collapseDetailsINEX($task, $detail);
      } else if (taskFormat == 'll-api') {
        collapseDetailsLLAPI($task, $detail);
      }
    }

    function expandDetailsINEX($task, $detail) {
      $task.find('.expand-btn i.icon').removeClass('icon-plus').addClass('icon-minus');
      $detail.removeClass('d-hide');
    }

    function collapseDetailsINEX($task, $detail) {
      $task.find('.expand-btn i.icon').removeClass('icon-minus').addClass('icon-plus');
      $detail.addClass('d-hide');
    }

    function expandDetailsLLAPI($task, $detail) {
      var outcomeURL = $task.data('outcome-url');
      $task.find('.expand-btn i.icon').removeClass('icon-plus').addClass('icon-minus');
      $detail.removeClass('d-hide');
      $.ajax({ url: outcomeURL }).done(function(html) {
        $detail.find('.loading').addClass('d-hide');
        $detail.find('.outcome').html(html);
      });
    }

    function collapseDetailsLLAPI($task, $detail) {
      $task.find('.expand-btn i.icon').removeClass('icon-minus').addClass('icon-plus');
      $detail.addClass('d-hide');
      $detail.find('.loading').removeClass('d-hide');
      $detail.find('.outcome').html('');
    }
  })();
</script>

{% if error %}
<script type="text/javascript">
  (function() {
    $('#error .message').text('{{ error }}');
    $('#error').removeClass('d-hide');
  })();
</script>
{% endif %}

{% endblock %}
